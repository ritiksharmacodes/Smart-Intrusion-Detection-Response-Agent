<!-- templates/view.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Intrusion Detection Response Agent - Live Computer Vision Stream – Powered by YOLOv8</title>
  <link rel="icon" type="image/svg+xml" href="../static/icon.svg" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h1>Live Viewer</h1>
    <div class="controls-row">
      <a style="color:white;" class="btn" href="{{ url_for('index') }}">← Upload new</a>
      <div class="file-info">File: <strong>{{ filename }}</strong></div>
    </div>

    <div class="player-card" style="display:flex; gap:24px;">
      <!-- LEFT: Video vertically centered -->
      <div style="flex:1; display:flex; justify-content:center; align-items:center;">
        <div class="video-box">
          <img id="mjpeg" src="{{ url_for('video_feed') }}?file={{ filename }}" alt="Live stream" />
        </div>
      </div>

      <!-- RIGHT: Controls + Metrics -->
      <div style="width:320px; display:flex; flex-direction:column; gap:20px;">

        <!-- Start/Stop Row -->
        <div style="display:flex; gap:12px;">
          <button id="startBtn" class="btn primary" style="flex:1;">Start</button>
          <button id="stopBtn" class="btn secondary" style="flex:1;">Stop</button>
        </div>

        <!-- Download Original -->
        <a class="btn" href="{{ url_for('download_file', folder='uploads', filename=filename) }}">Download original</a>


        <!-- Metrics (future-proof stacked list) -->
        <div class="metrics-box" style="background:#1d2126; padding:14px 16px; border-radius:10px; border:1px solid #1f2328;">

          <!-- Metric Row: Current People -->
          <div class="metric-row" style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <div class="metric-label" style="color:#9ca3af;">Current people detected:</div>
            <div id="currentCount" class="metric-value" style="color:#0b84ff; font-weight:700;">—</div>
          </div>

          <!-- Future metrics can be added below easily -->
        </div>
      </div>
    </div>


    <section class="recent">
      <h3>Other uploads</h3>
      <ul>
        {% for f in uploads %}
          <li><a href="{{ url_for('view_file', filename=f) }}">{{ f }}</a></li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <script>
    const filename = "{{ filename }}";
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const currentCountEl = document.getElementById("currentCount");
    const avgCountEl = document.getElementById("avgCount");

    async function setControl(action) {
      try {
        const res = await fetch("/control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file: filename, action })
        });
        const j = await res.json();
        if (!j.ok) console.warn("control failed", j);
        else {
          startBtn.disabled = j.running;
          stopBtn.disabled = !j.running;
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Poll stats endpoint every 600ms
    async function pollStats() {
      try {
        const res = await fetch(`/stats?file=${encodeURIComponent(filename)}`);
        const j = await res.json();
        if (j && j.ok) {
          currentCountEl.textContent = j.current_count;
          avgCountEl.textContent = j.avg_people.toFixed ? j.avg_people.toFixed(2) : j.avg_people;
        }
      } catch (e) {
        // ignore transient errors
        // console.error("stats error", e);
      } finally {
        setTimeout(pollStats, 600);
      }
    }

    // initial: Stop disabled (we don't auto-start), enable both
    startBtn.onclick = () => setControl("start");
    stopBtn.onclick = () => setControl("stop");

    // start polling as soon as page loads
    window.addEventListener('load', () => {
      pollStats();
    });
  </script>

  <style>
  .counts-row { display:flex; gap:20px; margin-top:12px; }
  .count-item { background:#1d2126; padding:12px 16px; border-radius:10px; min-width:180px; text-align:center; border:1px solid #1f2328; }
  .count-label { font-size:13px; color:#9ca3af; margin-bottom:6px; }
  .count-value { font-size:22px; font-weight:700; color:#0b84ff; }
</style>

</body>
</html>
